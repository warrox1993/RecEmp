<div class="kanban-container">
  <!-- Header avec stats et actions -->
  <div class="kanban-header">
    <div class="header-info">
      <h1>
        <mat-icon>view_kanban</mat-icon>
        Pipeline des Candidatures
      </h1>
      <div class="stats-chips">
        <mat-chip-set>
          <mat-chip class="total-chip">
            <mat-icon>work_outline</mat-icon>
            {{ stats().totalCandidatures }} candidatures
          </mat-chip>
          <mat-chip class="progress-chip" *ngIf="stats().progressToday > 0">
            <mat-icon>trending_up</mat-icon>
            +{{ stats().progressToday }} aujourd'hui
          </mat-chip>
          <mat-chip class="urgent-chip" *ngIf="urgentCandidatures().length > 0">
            <mat-icon>priority_high</mat-icon>
            {{ urgentCandidatures().length }} urgent{{ urgentCandidatures().length > 1 ? 's' : '' }}
          </mat-chip>
        </mat-chip-set>
      </div>
    </div>

    <div class="header-actions">
      <!-- Filtres rapides -->
      <mat-form-field appearance="outline" class="quick-filter">
        <mat-label>Filtre rapide</mat-label>
        <mat-select [(value)]="quickFilter" (selectionChange)="applyQuickFilter()">
          <mat-option value="">Tout voir</mat-option>
          <mat-option value="urgent">Urgent uniquement</mat-option>
          <mat-option value="high-priority">Haute priorité</mat-option>
          <mat-option value="overdue">En retard</mat-option>
          <mat-option value="recent">Récent (7j)</mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-raised-button color="primary" (click)="addNewCandidature()">
        <mat-icon>add</mat-icon>
        Nouvelle candidature
      </button>

      <button mat-stroked-button (click)="toggleView()">
        <mat-icon>view_list</mat-icon>
        Vue liste
      </button>

      <button mat-icon-button [matMenuTriggerFor]="moreActionsMenu" matTooltip="Plus d'actions">
        <mat-icon>more_vert</mat-icon>
      </button>
      <mat-menu #moreActionsMenu="matMenu">
        <button mat-menu-item (click)="exportData()">
          <mat-icon>download</mat-icon>
          <span>Exporter CSV</span>
        </button>
        <button mat-menu-item (click)="refreshData()">
          <mat-icon>refresh</mat-icon>
          <span>Actualiser</span>
        </button>
        <button mat-menu-item (click)="showStats()">
          <mat-icon>analytics</mat-icon>
          <span>Statistiques</span>
        </button>
        <button mat-menu-item (click)="runAutomation()">
          <mat-icon>auto_fix_high</mat-icon>
          <span>Automatisation</span>
        </button>
        <button mat-menu-item (click)="cleanupOldData()">
          <mat-icon>cleaning_services</mat-icon>
          <span>Nettoyer anciennes données</span>
        </button>
      </mat-menu>
    </div>
  </div>

  <!-- Indicateur de performance amélioré -->
  <div class="performance-indicator" *ngIf="conversionRate() > 0">
    <div class="performance-header">
      <span class="performance-label">Performance globale</span>
      <span class="performance-value">{{ conversionRate() }}% de succès</span>
    </div>
    <mat-progress-bar mode="determinate" [value]="conversionRate()" [color]="getPerformanceColor()"></mat-progress-bar>
    <div class="performance-details">
      <span>{{ stats().accepte }} accepté{{ stats().accepte > 1 ? 's' : '' }} sur {{ stats().total }}</span>
      <span>Temps moyen: {{ averageTimeInPipeline() }}j</span>
    </div>
  </div>

  <!-- Alertes et notifications -->
  <div class="kanban-alerts" *ngIf="hasActiveAlerts()">
    <mat-card class="alert-card">
      <div class="alert-content">
        <mat-icon class="alert-icon">notification_important</mat-icon>
        <div class="alert-text">
          <strong>{{ getAlertCount() }} action{{ getAlertCount() > 1 ? 's' : '' }} requise{{ getAlertCount() > 1 ? 's' : '' }}</strong>
          <p>{{ getAlertMessage() }}</p>
        </div>
        <button mat-button color="primary" (click)="handleAlerts()">Traiter</button>
      </div>
    </mat-card>
  </div>

  <!-- Colonnes Kanban -->
  <div class="kanban-board"
       cdkDropListGroup
       [@slideIn]="columns().length"
       [class.loading]="isLoading()">

    <div *ngFor="let column of filteredColumns(); trackBy: trackByColumn"
         class="kanban-column"
         [style.--column-color]="column.color"
         [class.limit-warning]="isNearLimit(column)"
         [class.limit-exceeded]="isLimitExceeded(column)">

      <!-- En-tête de colonne amélioré -->
      <div class="column-header">
        <div class="column-info">
          <div class="column-title-section">
            <mat-icon [style.color]="column.color">{{ column.icon }}</mat-icon>
            <h3>{{ column.title }}</h3>
            <span class="column-count"
                  [class.warning]="isNearLimit(column)"
                  [class.error]="isLimitExceeded(column)">
              {{ column.candidatures.length }}
              <span *ngIf="column.maxItems">/{{ column.maxItems }}</span>
            </span>
          </div>
          <p class="column-description">{{ column.description }}</p>

          <!-- Métriques de colonne -->
          <div class="column-metrics" *ngIf="getColumnMetrics(column.id) as metrics">
            <div class="metric-item" *ngIf="metrics.avgDays > 0">
              <mat-icon>schedule</mat-icon>
              <span>{{ metrics.avgDays }}j moy.</span>
            </div>
            <div class="metric-item" *ngIf="metrics.conversionRate > 0">
              <mat-icon>trending_up</mat-icon>
              <span>{{ metrics.conversionRate }}% conv.</span>
            </div>
          </div>
        </div>

        <!-- Indicateurs de colonne -->
        <div class="column-indicators">
          <div class="limit-indicator"
               *ngIf="isNearLimit(column)"
               [matTooltip]="getLimitTooltip(column)">
            <mat-icon [color]="isLimitExceeded(column) ? 'warn' : 'accent'">
              {{ isLimitExceeded(column) ? 'error' : 'warning' }}
            </mat-icon>
          </div>
          <button mat-icon-button
                  class="column-menu-btn"
                  [matMenuTriggerFor]="columnMenu"
                  matTooltip="Actions de colonne">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #columnMenu="matMenu">
            <button mat-menu-item (click)="addCandidatureToColumn(column.id)">
              <mat-icon>add</mat-icon>
              <span>Ajouter ici</span>
            </button>
            <button mat-menu-item (click)="sortColumn(column.id, 'priority')">
              <mat-icon>sort</mat-icon>
              <span>Trier par priorité</span>
            </button>
            <button mat-menu-item (click)="sortColumn(column.id, 'date')">
              <mat-icon>event</mat-icon>
              <span>Trier par date</span>
            </button>
            <button mat-menu-item (click)="bulkActionColumn(column.id, 'set-reminder')">
              <mat-icon>alarm_add</mat-icon>
              <span>Rappel pour toutes</span>
            </button>
            <button mat-menu-item (click)="bulkActionColumn(column.id, 'mark-priority')">
              <mat-icon>priority_high</mat-icon>
              <span>Marquer prioritaires</span>
            </button>
          </mat-menu>
        </div>
      </div>

      <!-- Zone de drop avec feedback amélioré -->
      <div class="column-content"
           cdkDropList
           [cdkDropListData]="column.candidatures"
           [id]="column.id"
           (cdkDropListDropped)="drop($event)"
           [cdkDropListEnterPredicate]="canDrop">

        <!-- Message si vide avec suggestions -->
        <div *ngIf="column.candidatures.length === 0" class="empty-column">
          <mat-icon [style.color]="column.color">{{ column.icon }}</mat-icon>
          <p>{{ getEmptyColumnMessage(column.id) }}</p>
          <button mat-stroked-button
                  *ngIf="canAddToColumn(column.id)"
                  (click)="addCandidatureToColumn(column.id)"
                  class="add-first-btn"
                  [style.border-color]="column.color"
                  [style.color]="column.color">
            <mat-icon>add</mat-icon>
            {{ getAddButtonText(column.id) }}
          </button>

          <!-- Suggestions d'automation -->
          <div class="automation-suggestion" *ngIf="getAutomationSuggestion(column.id) as suggestion">
            <button mat-button (click)="applyAutomationSuggestion(suggestion)">
              <mat-icon>auto_fix_high</mat-icon>
              {{ suggestion.text }}
            </button>
          </div>
        </div>

        <!-- Cartes des candidatures -->
        <div *ngFor="let candidature of column.candidatures; trackBy: trackByCandidature"
             cdkDrag
             [cdkDragData]="candidature"
             class="drag-item"
             [class.overdue]="isOverdue(candidature)"
             [class.urgent]="isUrgent(candidature)"
             (cdkDragStarted)="onDragStart(candidature)"
             (cdkDragEnded)="onDragEnd()">

          <app-candidature-card
            [candidature]="candidature"
            [quickActions]="getContextualQuickActions(candidature, column.id)"
            [isDragging]="draggingCandidature() === candidature"
            (edit)="editCandidature($event)"
            (viewDetails)="viewCandidatureDetails($event)"
            (quickAction)="executeQuickAction($event)">
          </app-candidature-card>
        </div>
      </div>

      <!-- Footer avec actions rapides et stats -->
      <div class="column-footer">
        <div class="column-footer-stats" *ngIf="column.candidatures.length > 0">
          <span class="stat-item">
            <mat-icon>schedule</mat-icon>
            {{ getOldestInColumn(column.id) }}j max
          </span>
          <span class="stat-item" *ngIf="getUrgentInColumn(column.id) > 0">
            <mat-icon>priority_high</mat-icon>
            {{ getUrgentInColumn(column.id) }} urgent{{ getUrgentInColumn(column.id) > 1 ? 's' : '' }}
          </span>
        </div>

        <button mat-button
                *ngIf="canAddToColumn(column.id)"
                (click)="addCandidatureToColumn(column.id)"
                class="add-to-column-btn">
          <mat-icon>add</mat-icon>
          Ajouter ici
        </button>
      </div>
    </div>
  </div>

  <!-- Messages de feedback améliorés -->
  <div *ngIf="successMessage()"
       class="success-overlay"
       [@fadeInOut]>
    <div class="success-content">
      <mat-icon>{{ getSuccessIcon() }}</mat-icon>
      <span>{{ successMessage() }}</span>
    </div>
  </div>

  <!-- Indicateur d'automatisation active -->
  <div *ngIf="automationRunning()" class="automation-indicator">
    <mat-card>
      <div class="automation-content">
        <span>Automatisation en cours...</span>
        <button mat-button (click)="cancelAutomation()">Annuler</button>
      </div>
    </mat-card>
  </div>
</div>
